---

- name: Exclude postgres in list of repositories
  ini_file: "path=/etc/yum.repos.d/Sangoma-Base.repo section={{ item }} option=exclude no_extra_spaces=yes value=postgres* state=present"
  with_items:
      - sng-base
      - sng-updates
  when: ansible_os_family == "Sangoma"

- name: Exclude postgres in list of repositories
  ini_file: "path=/etc/yum.repos.d/CentOS-Base.repo section={{ item }} option=exclude no_extra_spaces=yes value=postgres* state=present"
  with_items:
      - base
      - updates
  when: ansible_os_family == "RedHat"

- name: Update/upgrade of freepbx
  yum: name='*' state=latest update_cache=yes
  when: ansible_os_family == "Sangoma"

- name: Install the necessary packages
  yum: name={{ item }} state=present
  with_items:
      - libevent*
      - json-*
      - libunistring-devel.x86_64
      - webkitgtk3-devel.x86_64
      - perl*
      - librabbitmq*
      - bison
      - pcre-devel
      - libpcap-devel
      - flex
      - git
      - gcc
      - gcc-c++
      - bison-devel
      - make
      - expat
      - expat-devel
      - net-snmp-devel
      - libxml2
      - libxml2-devel
      - openssl-devel
      - xmlrpc-c-devel
      - lynx
      - pcre
      - pcre-devel
      - ncurses-devel
      - ncurses-libs
      - gdb
      - unixODBC
      - unixODBC-devel
      - libtool-ltdl-devel
      - xmlrpc-c-devel
      - lynx
      - pcre
      - pcre-devel
      - iptables-devel
      - iptables-services
      - xmlrpc-c-devel
      - libpcap-devel
      - glib2-devel
      - json-glib-devel
      - libevent-devel
      - redis
      - hiredis
      - hiredis-devel
      - kernel-devel
      - kernel-headers
      - xmlrpc-c-devel
      - python-devel
      - libuuid
      - libuuid-devel
      - expect.x86_64
      - expect-devel.x86_64
      - MySQL-python.x86_64

- name: Change /etc/hostname
  template: src=templates/hostname.j2 dest=/etc/hostname

- name: Creation of freetech user and group
  group: name=freetech state=present
  when: ansible_os_family == "Sangoma"
- user: "name=freetech group=freetech state=present"
  when: ansible_os_family == "Sangoma"

- name: Creation of asterisk user and group
  group: name=asterisk state=present
  when: ansible_os_family == "RedHat"
- user: "name=asterisk group=asterisk state=present"
  when: ansible_os_family == "RedHat"

- name: Add freetech user to sudo privilege
  lineinfile: "dest=/etc/sudoers line=\"freetech    ALL=(ALL)       ALL\""

- name: Create public key of freetech user
  user: name=freetech generate_ssh_key=yes ssh_key_bits=2048

- name: Transfer ssh key from freetech's user to root's user
  shell: cat /home/freetech/.ssh/id_rsa.pub
  register: ssh_key
- authorized_key: user=root key={{ ssh_key.stdout }} state=present

- name: Reboot the server for kernel update
  shell: sleep 2 && shutdown -r now "Ansible updates triggered"
  async: 1
  poll: 0
  become: true
  ignore_errors: true

- name: Wait for the server to finish rebooting
  become: yes
  become_user: root
  local_action: wait_for host="{{ omnifreepbx_ip }}" delay=15 state=started port={{ sangoma_ssh_port }} timeout=300
  when: ansible_os_family == "Sangoma"

- name: Wait for the server to finish rebooting
  become: yes
  become_user: root
  local_action: wait_for host="{{ omnicentos_ip }}" delay=15 state=started port={{ centos_ssh_port }} timeout=300
  when: ansible_os_family == "RedHat"