---

- hosts: omni-app
  tasks:
          - name: Add the repository key
           #shell: "apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys EEA14886"
            apt_key: keyserver=keyserver.ubuntu.com state=present id=0xC2518248EEA14886
           
          - name: Add wombat dialer repositories
            apt_repository: "repo={{ item }} state=present filename=webupd8team-java update_cache=yes codename=xenial"
            with_items:
                    - deb http://ppa.launchpad.net/webupd8team/java/ubuntu xenial main
                    - deb-src http://ppa.launchpad.net/webupd8team/java/ubuntu xenial main

                      #- name: Update for repositories
                      #apt: update_cache=yes cache_valid_time=12

          - name: Accept Java8 license
            debconf: name='oracle-java8-installer' question='shared/accepted-oracle-license-v1-1' value='true' vtype='select'
          
          - name: Install oracle8 and tomcat8
            apt: name={{ item }} state=present
            with_items:
                    - oracle-java8-installer
                    - tomcat8
                    - libmysql-java

          - name: Get wombat dialer 
            get_url: url={{ wombat }} dest=/var/lib/tomcat8/webapps/
            register: destino

          - name: Unarchive downloaded package 
            unarchive: src={{ destino.dest }} dest=/var/lib/tomcat8/webapps remote_src=yes
            register: nombres_tar

          - name: Erase of the tar
            file: dest={{ nombres_tar.src }} state=absent

          - action: shell ls /var/lib/tomcat8/webapps/
            register: dirwebapps

          - command: mv /var/lib/tomcat8/webapps/{{ dirwebapps.stdout_lines[1] }} /var/lib/tomcat8/webapps/wombat
            ignore_errors: yes

          - name: Copy of mysql-connector-java.jar
            copy: src=/usr/share/java/mysql-connector-java.jar dest=/var/lib/tomcat8/webapps/wombat/WEB-INF/lib/ remote_src=yes
            ignore_errors: yes

          - name: Change JAVA_HOME
            lineinfile: "dest=/etc/default/tomcat8 regexp=\"^#JAVA_HOME=\" line=\"JAVA_HOME=/usr/lib/jvm/java-8-oracle\""
            notify: restart tomcat8

          - name: Set MySQL root password before installing
            debconf: name='mysql-server' question='mysql-server/root_password' value='{{mysql_root_pass | quote}}' vtype='password'

          - name: Confirm MySQL root password before installing
            debconf: name='mysql-server' question='mysql-server/root_password_again' value='{{mysql_root_pass | quote}}' vtype='password'

          - name: Install Mysql
            apt: name=mysql-server state=present

  handlers:
          - name: restart tomcat8
            service: name=tomcat8 state=restarted enabled=yes 

