#!/bin/bash
# Script para realizar backup/restore de la herramienta

# Inicializaci√≥n de variables
FECHA=`date +%Y%m%d`
export PGPASSWORD=""

Backup() {

    mkdir /tmp/omnileads-backup/$FECHA-omnileads-backup

    #Asterisk Files
    mkdir -p /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/etc
    mkdir -p /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/agi-bin
    mkdir -p /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/sounds
    cp -L {{ asterisk_location }}/etc/asterisk/* /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/etc
    cp {{ asterisk_location }}/var/lib/asterisk/agi-bin/* /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/agi-bin
    cp {{ asterisk_location }}/var/lib/asterisk/sounds/* /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/sounds
    cp /usr/local/parselog/conversor.sh /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk
    tar czvf /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk.tgz /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/*
    rm -rf /tmp/omnileads-backup/$FECHA-omnileads-backup/asterisk/

    #Kamailio Files
    mkdir /tmp/omnileads-backup/$FECHA-omnileads-backup/kamailio
    cp -La {{ kamailio_location}}/etc/ /tmp/omnileads-backup/$FECHA-omnileads-backup/kamailio
    tar czvf /tmp/omnileads-backup/$FECHA-omnileads-backup/kamailio.tgz /tmp/omnileads-backup/$FECHA-omnileads-backup/kamailio/*
    rm -rf /tmp/omnileads-backup/$FECHA-omnileads-backup/kamailio/

    #Django Files
    mkdir /tmp/omnileads-backup/$FECHA-omnileads-backup/django
    rsync -L -av --exclude=asterisk --exclude=kamailio --exclude=virtualenv --exclude=backup {{ install_prefix }}/ /tmp/omnileads-backup/$FECHA-omnileads-backup/django
    tar czvf /tmp/omnileads-backup/$FECHA-omnileads-backup/django.tgz /tmp/omnileads-backup/$FECHA-omnileads-backup/django/.
    rm -rf /tmp/omnileads-backup/$FECHA-omnileads-backup/django

    #Databases
    mkdir /tmp/omnileads-backup/$FECHA-omnileads-backup/postgres_database
    pg_dump -U kamailio -w -h 127.0.0.1 kamailio -f /tmp/omnileads-backup/$FECHA-omnileads-backup/postgres_database/base_backup.sql
    tar czvf /tmp/omnileads-backup/$FECHA-omnileads-backup/postgres_database.tgz /tmp/omnileads-backup/$FECHA-omnileads-backup/postgres_database/*
    rm -rf /tmp/omnileads-backup/$FECHA-omnileads-backup/postgres_database/

    # Tar the last directory
    mkdir -p {{ install_prefix }}/backup
    #tar czvf $FECHA-omnileads-backup.tgz /tmp/omnileads-backup/$FECHA-omnileads-backup/
    cd /tmp/omnileads-backup && tar czvf $FECHA-omnileads-backup.tgz $FECHA-omnileads-backup
    mv /tmp/omnileads-backup/$FECHA-omnileads-backup.tgz {{ install_prefix }}backup
    rm -rf /tmp/omnileads-backup/
    }

Restore() {
    set -e
    ARRAY=(asterisk.tgz django.tgz kamailio.tgz postgres_database.tgz)
    tar_backup=$1
    tar_directory=`echo $1 | awk -F "." '{print $1}'`
    cd {{ install_prefix }}backup
    tar xzvf $tar_backup
    cd $tar_directory
    for counter in {0..3}; do
        tar xzvf ${ARRAY[counter]}
    done
    cd tmp/omnileads-backup/$tar_directory/

    #Restore of asterisk files
    cd asterisk
    cp -a agi-bin/* {{ asterisk_location }}/var/lib/asterisk/agi-bin/
    cp -a etc/* {{ asterisk_location }}/etc/asterisk/
    cp -a conversor.sh /usr/local/parselog
    cp -a sounds/* {{ asterisk_location }}/var/lib/asterisk/sounds/

    #Restore of kamailio files
    cd ../kamailio/etc
    cp -a certs {{ kamailio_location}}/etc/certs
    cp -a kamailio {{ kamailio_location}}/etc/kamailio

    #Restore of Django files
    cd ../../django
    cp -a * {{ install_prefix }}ominicontacto

    #Restore of Database
    cd ../postgres_database
    psql -U kamailio -w -h 127.0.0.1 -d kamailio -f base_backup.sql

    rm -rf /opt/omnileads/backup/tar_directory

}

while getopts "r:b" OPTION;do
	case "${OPTION}" in
		r) # Rama a deployar
            Restore $OPTARG
		;;
		b) #Realizar pasos y agregar opciones preliminares
		    Backup
		;;
	esac
done
if [ $# -eq 0  ]; then echo -n; fi