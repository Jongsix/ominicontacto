{% extends "base.html" %}
{% load static %}
{% block head_js %}
<script type="text/javascript">
   $(function() {
                var start = moment();
                var end = moment();
                function cb(start, end) {
                    $('#id_fecha').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                }

 $('#id_fecha').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
  });

  $('#id_fecha').on('cancel.daterangepicker', function(ev, picker) {
      $(this).val('');
});

            // Init daterange plugin
            $('#id_fecha').daterangepicker(
                {

                locale: {
                    format: 'DD/MM/YYYY'
                 },

                startDate: start,
                endDate: end,
                ranges: {
                    'Hoy': [moment(), moment()],
                    'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Ultimos 7 Días': [moment().subtract(6, 'days'), moment()],
                    'Ultimos 30 Días': [moment().subtract(29, 'days'), moment()],
                    'Este Mes': [moment().startOf('month'), moment().endOf('month')],
                    'Ultimo Mes': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },

        }, cb);

        cb(start, end);

        $("#id_agente").change(function() {
                if( $("#id_agente").val() == null) {
                    $("#id_grupo_agente").removeAttr('disabled');
                    $("#id_todos_agentes").removeAttr('disabled');
                } else {
                    $("#id_grupo_agente").attr('disabled', true);
                    $("#id_todos_agentes").attr('disabled', true);
                }
            });

            $("#id_grupo_agente").change(function() {
                if( $("#id_grupo_agente").val() == "") {
                    $("#id_agente").removeAttr('disabled');
                    $("#id_todos_agentes").removeAttr('disabled');
                } else {
                    $("#id_agente").attr('disabled', true);
                    $("#id_todos_agentes").attr('disabled', true);
                }
            });

        $("#id_todos_agentes").change(function() {

                if( $("#id_todos_agentes").prop("checked") ) {
                    $("#id_agente").attr('disabled', true);
                    $("#id_grupo_agente").attr('disabled', true);
                } else {

                    $("#id_agente").removeAttr('disabled');
                    $("#id_grupo_agente").removeAttr('disabled');
                }
            });
    $('.tiemposAgenteModal').click(function(){
    event.preventDefault();
    var id_agente;
    id_agente = $(this).attr("id_agente");
    var fecha_desde = $(this).attr("fecha_desde");
    var fecha_hasta = $(this).attr("fecha_hasta");
    debugger;;
    $.ajax(
    {
        type:"POST",
        url: "/reportes/agente_por_fecha/",
        data:{
                 'id_agente': id_agente,
                 'fecha_desde': fecha_desde,
                 'fecha_hasta': fecha_hasta,
                  'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (data, textStatus) {
            //alert(data, textStatus);
            $('#output').html(data); // append to inner html
        },
        error: function(xhr, status, e) {
            alert(status, e);
        }
     })
});

});


    </script>
{% endblock %}
{% block content %}

<h1>Agentes</h1>
<div id="wrapper-search">

    <button id="btnCollapse" class="btn btn-block" type="button" data-toggle="collapse" data-target="#wrapperSearchForm" aria-expanded="true" aria-controls="wrapperSearchForm"><span class="icon icon-search"></span> Buscar</button>

    <div id="wrapperSearchForm" class="show">

        <form role="form" method="post" enctype="multipart/form-data" >
            {% csrf_token %}
            {{ form.non_field_errors }}
            <div class="form-row">
                <div class="col-md-6">
                    <label for="{{ form.fecha.id_for_label }}">Fecha: </label>
                    {{form.fecha}}
                    {{ form.fecha.errors }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.agente.id_for_label }}">Agente: </label>
                      {{ form.agente }}
                      {{ form.agente.errors }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.todos_agentes.id_for_label }}">Todos los agentes: </label>
                      {{ form.todos_agentes }}
                      {{ form.todos_agentes.errors }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.agente.id_for_label }}">Grupo de agentes: </label>
                      {{ form.grupo_agente }}
                      {{ form.grupo_agente.errors }}
                </div>
            </div>

            <button type="submit" id="id_buscar_btn" class="btn btn-primary">
                Buscar
            </button>
        </form>
    </div>
</div>

{% if graficos_estadisticas  %}

<div>
    <h2>Periodo evaluado {{graficos_estadisticas.fecha_desde|date:"d/m/Y"}} - {{graficos_estadisticas.fecha_hasta|date:"d/m/Y"}}</h2>
    <hr>
    <table class="table">
    <thead>
        <tr>
            <th>Agente</th>
            <th>Tiempo de session</th>
            <th>Tiempo de pausa</th>
            <th>Tiempos en llamada</th>
            <th>Porcentaje en llamada</th>
            <th>Porcentaje en pausa</th>
            <th>Porcentaje en espera</th>
            <th>Cantidad de llamadas procesadas</th>
            <th>Tiempo promedio de llamadas</th>
            <th>Cantidad de intentos fallidos</th>
        </tr>
    </thead>
    {% for agente in graficos_estadisticas.agentes_tiempos %}
        <tr>
            <td>{{agente.get_nombre_agente}}
                <a href="#" role="button" class="tiemposAgenteModal" id_agente="{{agente.agente.id}}" data-toggle="modal" data-target="#reporteFechaModal"
                fecha_desde="{{graficos_estadisticas.fecha_desde|date:'d/m/Y'}}" fecha_hasta="{{graficos_estadisticas.fecha_hasta|date:'d/m/Y'}}">
 ver por fechas</a>

            </td>
            <td>
                {% if agente.get_string_tiempo_sesion %}
                    {{agente.get_string_tiempo_sesion}}hs
                {% else %}
                    0hs
                {% endif %}
            </td>
            <td>
                {% if agente.get_string_tiempo_pausa %}
                    {{agente.get_string_tiempo_pausa}}hs
                {% else %}
                    0hs
                {% endif %}
            </td>
            <td>{{agente.get_string_tiempo_llamada}}hs</td>
            <td>
                {% if agente.tiempo_porcentaje_llamada %}
                    {{agente.tiempo_porcentaje_llamada|floatformat:4}}%
                {% else %}
                    0%
                {% endif %}
            </td>
            <td>
                {% if agente.tiempo_porcentaje_pausa %}
                    {{agente.tiempo_porcentaje_pausa|floatformat:4}}%
                {% else %}
                    0%
                {% endif %}
            </td>
            <td>
                {% if agente.tiempo_porcentaje_wait %}
                    {{agente.tiempo_porcentaje_wait|floatformat:4}}%
                {% else %}
                    0%
                {% endif %}
            </td>
            <td>{{agente.cantidad_llamadas_procesadas}}</td>
            <td>{{agente.get_promedio_llamadas}}s</td>
            <td>{{agente.cantidad_intentos_fallidos}}</td>
        </tr>
    {% endfor %}
    <tbody>

    </tbody>
</table>

    <a class="btn btn-outline-primary" target="_blank" href="{% url 'reportes_agentes_exporta' tipo_reporte='tiempos_agentes' %}">Exportar reporte de tiempos(CSV)</a>
</div>
<hr>
<div>
<table class="table">
    <thead>
        <tr>
            <th>Agente</th>
            <th>Pausa</th>
            <th>Tipo de pausa</th>
            <th>Tiempo de pausa</th>

        </tr>
    </thead>
    {% for agente in graficos_estadisticas.agente_pausa %}
        <tr>
            <td>{{agente.nombre_agente}}</td>
            <td>{{agente.pausa}}</td>
            <td>{{agente.tipo_de_pausa}}</td>
            <td>{{agente.tiempo}}hs</td>
        </tr>
    {% endfor %}
    <tbody>

    </tbody>
</table>
    <a class="btn btn-outline-primary" target="_blank" href="{% url 'reportes_agentes_exporta' tipo_reporte='pausas_agentes' %}">Exportar reporte de pausas(CSV)</a>

</div>
<hr>
<div>
<table class="table">
    <thead>
        <tr>
            <th>Agente</th>
            <th>Cola</th>
            <th>Tiempos de llamadas</th>
            <th>Cantidad de llamadas procesadas</th>

        </tr>
    </thead>
    {% for agente in graficos_estadisticas.count_llamada_campana %}
        <tr>
            <td>{{agente.0}}</td>
            <td>{{agente.1}}</td>
            <td>{{agente.2}}hs</td>
            <td>{{agente.3}}</td>

        </tr>
    {% endfor %}
    <tbody>

    </tbody>
</table>
<a class="btn btn-outline-primary" target="_blank" href="{% url 'reportes_agentes_exporta' tipo_reporte='llamadas_agentes' %}">Exportar reporte cantidad llamadas(CSV)</a>
</div>
<hr>
<div>
    <h2>Cantidad de llamadas por agente</h2>
    <br>
    <div class="form-row">
        <div class="col-lg-6">
            <table class="table">
                <thead>
                <tr>
                    <th>Agente</th>
                    <th>Total </th>
                    <th>PREVIEW</th>
                    <th>DIALER</th>
                    <th>INBOUND</th>
                    <th>MANUAL</th>
                </tr>
                </thead>
                <tbody>
                    {% for agente, total_campana, total_preview, total_dialer, total_inbound, total_manual in graficos_estadisticas.dict_agente_counter %}
                        <tr>
                            <td>{{ agente }}</td>
                            <td>{{ total_campana }}</td>
                            <td>{{ total_preview }}</td>
                            <td>{{ total_dialer }}</td>
                            <td>{{ total_inbound }}</td>
                            <td>{{ total_manual }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-lg-6">
            <div class="graficos-avances">
                <figure>
                    {{ graficos_estadisticas.barra_agente_total.render|safe }}
                </figure>
            </div>
        </div>
    </div>
    <a class="btn btn-outline-primary" target="_blank" href="{% url 'reportes_agentes_exporta' tipo_reporte='llamadas_tipo_agentes' %}">Exportar reporte de tipo de llamadas(CSV)</a>

</div>

<!-- Modal -->
<div class="modal fade" id="reporteFechaModal" tabindex="-1" role="dialog" aria-labelledby="reporteFechaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reporteFechaModalLabel">Agente</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tiempo de session</th>
                        <th>Tiempo de pausa</th>
                        <th>Tiempos en llamada</th>
                        <th>Porcentaje en llamada</th>
                        <th>Porcentaje en pausa</th>
                        <th>Porcentaje en espera</th>
                        <th>Cantidad de llamadas procesadas</th>
                        <th>Tiempo promedio de llamadas</th>
                        <th>Cantidad de intentos fallidos</th>
                    </tr>
                </thead>
                <tbody id="output">
                </tbody>
            </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}