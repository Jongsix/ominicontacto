; Copyright (C) 2018 Freetech Solutions

; This file is part of OMniLeads

; This program is free software: you can redistribute it and/or modify
; it under the terms of the GNU General Public License as published by
; the Free Software Foundation, either version 3 of the License, or
; (at your option) any later version.

; This program is distributed in the hope that it will be useful,
; but WITHOUT ANY WARRANTY; without even the implied warranty of
; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
; GNU General Public License for more details.

; You should have received a copy of the GNU General Public License
; along with this program.  If not, see http://www.gnu.org/licenses/.

; OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML
; OML OML OML OML OML OML OML OML OML OML         MODULES SUBRUTINES      OML OML OML OML OML OML OML OML OML OML
; OML OML OML OML OML OML OML OML OML OML         MODULES SUBRUTINES      OML OML OML OML OML OML OML OML OML OML
; OML OML OML OML OML OML OML OML OML OML         MODULES SUBRUTINES      OML OML OML OML OML OML OML OML OML OML
; OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML OML

[sub-oml-module-ivr]
; subrutina que implementa modulo de IVR

include => sub-oml-module-ivr-custom

exten => s,1,Verbose(2, "The cost of sanity in this society, is a certain level﻿ of alienation" - Terrence McKenna)
same => n,Set(OMLIVRID=${ARG1})
same => n,Set(OMLIVRNAME=${DB(OML/IVR/${OMLIVRID}/NAME)})
same => n,Set(OMLIVROPTIONS=${DB(OML/IVR/${OMLIVRID}/OPTION/OPTIONS)})
same => n,Set(OMLIVRTORETRY=${DB(OML/IVR/${OMLIVRID}/TIMEOUT/RETRIES)})
same => n,Set(OMLIVRINVRETRY=${DB(OML/IVR/${OMLIVRID}/INVALID/RETRIES)})
same => n,Set(OMLIVRDEFAULTTODST=${DB(OML/IVR/${OMLIVRID}/TIMEOUT/DST)})
same => n,Set(OMLIVRDEFAULTINVDST=${DB(OML/IVR/${OMLIVRID}/INVALID/DST)})

same => n,Set(OMLTOCOUNT=1)
same => n,Set(OMLINVCOUNT=1)
same => n,Set(XCOUNT=1)

same => n(audio),Read(OMLIVRDTMF,${DB(OML/IVR/${OMLIVRID}/AUDIO)},,,1,${DB(OML/IVR/${OMLIVRID}/TIMEOUT/SECONDS)})
same => n,GotoIf($[${ISNULL(${OMLIVRDTMF})}]?nullDTMF)

same => n(while),Set(COUNTER=1)
same => n,While($[${COUNTER} <= ${OMLIVROPTIONS}])
same => n,GotoIf($["${OMLIVRDTMF}" == "${DB(OML/IVR/${OMLIVRID}/OPTION/${COUNTER}/DTMF)}"]?correctOpt)
same => n,Set(COUNTER=${INC(COUNTER)})
same => n,EndWhile()

same => n,Verbose(2, DTMF invalido para este IVR) ; retry & contador de fallos
same => n,GotoIf($[ISNULL(${${OMLIVRRETRY})}]?invalidDst)
same => n,Gosub(sub-oml-countdown,s,1(${XCOUNT},${OMLIVRINVRETRY}))
same => n,GotoIf($["${GOSUB_RETVAL}" == "0"]?invalidDst)
same => n,Goto(audio)

same => n(invalidDst),Gosub(sub-oml-dst-switch,s,1(${OMLIVRDEFAULTINVDST})
same => n,Gosub(sub-oml-hangup,s,1(FAIL-IVR))

same => n(nullDTMF),Verbose(2, DTMF nulo para este IVR)
same => n,GotoIf($[ISNULL(${${OMLIVRRETRY})]?timeOutDst)
same => n,Gosub(sub-oml-countdown,s,1(${XCOUNT},${OMLIVRTORETRY}))
same => n,GotoIf($["${GOSUB_RETVAL}" == "0"]?timeOutDst)
same => n,Goto(audio)

same => n(timeOutDst),Gosub(sub-oml-dst-switch,s,1(${OMLIVRDEFAULTTODST})
same => n,Gosub(sub-oml-hangup,s,1(FAIL-IVR))

same => n(correctOpt),Set(OMLOBJDST=${DB(OML/IVR/${OMLIVRID}/OPTION/${COUNTER}/DST)})
same => n,Gosub(sub-oml-dst-switch,s,1(${OMLOBJDST}))
same => n,Gosub(sub-oml-hangup,s,1(FAIL-IVR))


[sub-oml-module-time-groups]
include => sub-oml-module-time-groups-custom

exten => s,1,Verbose(2, OMLTGID: ${ARG1})
same => n,Set(OMLTGID=${ARG1})
same => n,Set(OMLTGENTRIES=${DB(OML/TG/${OMLTGID}/ENTRIES)})
; inicio While  inicio While  inicio While  inicio While  inicio While  inicio While
same => n(while),Set(OMLTGCOUNTER=1)
same => n,While($[${OMLTGCOUNTER} <= ${OMLTGENTRIES}])
same => n,Set(OMLTGHOURF=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/HOURF)})
same => n,Set(OMLTGHOURT=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/HOURT)})
same => n,Set(OMLTGDAYF=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/DAYF)})
same => n,Set(OMLTGDAYT=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/DAYT)})
same => n,Set(OMLTGDAYNUMF=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/DAYNUMF)})
same => n,Set(OMLTGDAYNUMT=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/DAYNUMT)})
same => n,Set(OMLTGMONTHF=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/MONTHF)})
same => n,Set(OMLTGMONTHT=${DB(OML/TG/${OMLTGID}/ENTRY/${OMLTGCOUNTER}/MONTHT)})

same => n,Set(OMLTGHOURRANGE=${OMLTGHOURF}-${OMLTGHOURT})
same => n,GotoIf($["${OMLTGHOURF}" == "${OMLTGHOURT}"]?setHourRange)

; check si el rango esta compuesto por el mismo valor
same => n(dayRangeSet),Set(OMLTGDAYRANGE=${OMLTGDAYF}-${OMLTGDAYT})
same => n,GotoIf($["${OMLTGDAYF}" == "${OMLTGDAYT}"]?setDayRange)

same => n(dayNumRangeSet),Set(OMLTGDAYNUMRANGE=${OMLTGDAYNUMF}-${OMLTGDAYNUMT})
same => n,GotoIf($["${OMLTGDAYNUMF}" == "${OMLTGDAYNUMT}"]?setDayNumRange)

same => n(monthRangeSet),Set(OMLTGMONTHRANGE=${OMLTGMONTHF}-${OMLTGMONTHT})
same => n,GotoIf($["${OMLTGMONTHF}" == "${OMLTGMONTHT}"]?setMonthRange)

same => n(checkTime),GotoIfTime(${OMLTGHOURRANGE},${OMLTGDAYRANGE},${OMLTGDAYNUMRANGE},${OMLTGMONTHRANGE}?trueCondition)

same => n,Set(OMLTGCOUNTER=${INC(OMLTGCOUNTER)})
same => n,EndWhile()
same => n,Set(__OMLTGRESULT=0)
same => n,Return(FAIL DIALPLAN)

; true destination
same => n(trueCondition),Set(__OMLTGRESULT=1)
same => n,Return()


; AUX set range variables, cuando variables DESDE HASTA son iguales
same => n(setHourRange),Set(OMLTGDAYRANGE=${OMLTGDAYF})
same => n,Gosub(sub-oml-hangup,s,1(error de hora))

same => n(setDayRange),Set(OMLTGDAYRANGE=${OMLTGDAYF})
same => n,Goto(dayNumRangeSet)

same => n(setDayNumRange),Set(OMLTGDAYNUMRANGE=${OMLTGDAYNUMF})
same => n,Goto(monthRangeSet)

same => n(setMonthRange),Set(OMLTGMONTHRANGE=${OMLTGMONTHF})
same => n,Goto(checkTime)


[sub-oml-module-time-conditions]
include => sub-oml-module-time-conditions-custom

exten => s,1,Verbose(2, OMLTCID: ${ARG1})
same => n,Set(OMLTCID=${ARG1})
same => n,Set(OMLTCTRUEDST=${DB(OML/TC/${OMLTCID}/TRUEDST)})
same => n,Set(OMLTCFALSEDST=${DB(OML/TC/${OMLTCID}/FALSEDST)})
same => n,Set(OMLTGID=${DB(OML/TC/${OMLTCID}/TGID)})
same => n,GoSub(sub-oml-module-time-groups,s,1(${OMLTGID}))
same => n,GotoIf($["${OMLTGRESULT}" == "1"]?trueCondition:falseCondition)
same => n,Gosub(sub-oml-hangup,s,1(fallo time-conditions module))

; false destination
same => n(trueCondition),Gosub(sub-oml-dst-switch,s,1(${OMLTCTRUEDST}))
same => n,Gosub(sub-oml-hangup,s,1(fail time-conditions module))

; true destination
same => n(falseCondition),Gosub(sub-oml-dst-switch,s,1(${OMLTCFALSEDST}))
same => n,Gosub(sub-oml-hangup,s,1(fail time-conditions module))



[sub-oml-module-survey]
include => sub-oml-module-survey-custom

exten => s,1,Verbose(2, "The cost of sanity in this society, is a certain level﻿ of alienation" - Terrence McKenna)
same => n,Set(OMLSURVEYID=${ARG1})
same => n,Set(OMLSURVEYNAME=${DB(OML/SURVEY/${OMLSURVEYID}/NAME)})
same => n,Set(OMLSURVEYQUESTIONS=${DB(OML/SURVEY/${OMLSURVEYID}/QUESTIONS)})
same => n,Set(OMLSURVEYINVRETRY=${DB(OML/SURVEY/${OMLSURVEYID}/RETRY)})
same => n,Set(OMLSURVEYTIMEOUT=${DB(OML/SURVEY/${OMLSURVEYID}/TIMEOUT)})

same => n,Playback(${DB(OML/SURVEY/${OMLSURVEYID}/WELCOMEAUDIO)})
same => n,Set(COUNTER=1)

same => n(while),GotoIf($[${COUNTER} <= ${OMLSURVEYQUESTIONS}]?:endWhile)

same => n,Set(OMLANS4QST${COUNTER}=${DB(OML/SURVEY/${OMLSURVEYID}/QST/${COUNTER}/ANSWERS)})
same => n,Set(OMLINVCOUNTER=1)
same => n(qstAudio),Read(OMLSURVEYANS,${DB(OML/SURVEY/${OMLSURVEYID}/QST/${COUNTER}/AUDIO)},,,1,${OMLSURVEYTIMEOUT})
same => n,Set(XCOUNTER=1)

same => n(answer),GotoIf($[${XCOUNTER} <= ${OMLANS4QST${COUNTER}}]?:incorrectAns)
same => n,GotoIf($[${OMLSURVEYANS} == ${DB(OML/SURVEY/${OMLSURVEYID}/QST/${COUNTER}/ANSWER/${XCOUNTER}/DTMF)}]?correctAns)
same => n,Set(XCOUNTER=${INC(XCOUNTER)})
same => n,Goto(answer)

same => n(incorrectAns),Verbose(2, no se ingreso una respuesta correcta, tengo que ver el tema retry ....)
same => n,Playback(pbx-invalid)
same => n,GotoIf($[ISNULL(${OMLSURVEYINVRETRY})]?nextQ)
same => n,Gosub(sub-oml-countdown,s,1(${OMLINVCOUNTER},${OMLSURVEYINVRETRY}))
same => n,GotoIf($["${GOSUB_RETVAL}" == "0"]?nextQ)
same => n,Goto(qstAudio)
same => n,Hangup()

same => n(correctAns),Verbose(2, Dest for answer ${OMLSURVEYANS}: ${DB(OML/SURVEY/${OMLSURVEYID}/QST/${COUNTER}/ANSWER/${XCOUNTER}/DST)})
same => n,Verbose(2, aca lanzo AGI o CURL con la respuesta ${OMLSURVEYANS} para la pregunta ${COUNTER})
same => n,Wait(5)
same => n,GotoIf($["${DB(OML/SURVEY/${OMLSURVEYID}/QST/${COUNTER}/ANSWER/${XCOUNTER}/DST)}" == "next"]?nextQ)
same => n,Gosub(sub-oml-dst-switch,s,1(${DB(OML/SURVEY/${OMLSURVEYID}/QST/${COUNTER}/ANSWER/${XCOUNTER}/DST)}))

same => n(nextQ),Set(COUNTER=${INC(COUNTER)})
same => n,Goto(while)

same => n(endWhile),Playback(${DB(OML/SURVEY/${OMLSURVEYID}/GREETINGAUDIO)})


[sub-oml-module-custmer-id]
include => sub-oml-module-custmer-id-custom

exten => s,1,Verbose(2, Inbound call customer identification ${ARG1})
same => n,Set(COUNTER=1)
same => n(idcontactReq),Read(__OMLCODCLI,${DB(OML/CUSTOMERID/${ARG1}/AUDIO)},${DB(OML/CUSTOMERID/${ARG1}/LENGTH)},,,${DB(OML/CUSTOMERID/${ARG1}/TIMEOUT)})
same => n,GotoIf($[${ISNULL(${OMLCODCLI})}]?nullDTMF)

same => n,Playback(${OMLLANG}/oml/oml-number-is)
same => n,SayDigits(${OMLCODCLI})
same => n,Read(CONFIRM,${OMLLANG}/oml/oml-to-confirm-press-one,1,,,5)
same => n,GotoIf($[${CONFIRM} == 1]?confirm)

same => n(nullDTMF),Set(COUNTER=${INC(COUNTER)})
same => n,GotoIf($[${COUNTER} > ${DB(OML/CUSTOMERID/${ARG1}/RETRIES)}]?goOut)
same => n,Goto(idcontactReq)

same => n(confirm),Verbose(ask about CUSTOMERID type)
same => n,GotoIf($[${DB(OML/CUSTOMERID/${ARG1}/TYPE)} == 2]?withCrmTF)
same => n,GotoIf($[${DB(OML/CUSTOMERID/${ARG1}/TYPE)} == 3]?withCrmDst)

same => n(withoutCrm),Verbose(2, only isnull OMLCODCLI test)
same => n,Gosub(sub-oml-dst-switch,s,1(${DB(OML/CUSTOMERID/${ARG1}/TRUEDST)}))
same => n,Return()

same => n(withCrmTF),Verbose(2, CRM true/false choice)
same => n,Set(CURLOPT(ssl_verifypeer)=0)
same => n,Set(CURLOPT(dnstimeout)=10)
same => n,Set(CURLOPT(conntimeout)=10)
same => n,Set(CURLOPT(httptimeout)=10)
same => n,Set(CURLOPT(useragent)=OMniLeads)
same => n,Set(CURL_RESULT=${CURL(${DB(OML/CUSTOMERID/${ARG1}/EXTERNALURL)},idContact=${OMLCODCLI})})
same => n,Verbose(2,${JSONELEMENT(CURL_RESULT,status)})
same => n,Verbose(2,${JSONELEMENT(CURL_RESULT,destination)})
same => n,ExecIf($["${JSONELEMENT(CURL_RESULT,status)}" == "ok"]?Set(CRMCHOICE=${JSONELEMENT(CURL_RESULT,destination)}):Goto(goOut))
same => n,GotoIf($["${CRMCHOICE}" != "true"]?goOut)
same => n,Gosub(sub-oml-dst-switch,s,1(${DB(OML/CUSTOMERID/${ARG1}/TRUEDST)}))
same => n,Return()

same => n(withCrmDst),Verbose(2, the CRM return de destination)
same => n,Set(CURLOPT(ssl_verifypeer)=0)
same => n,Set(CURLOPT(dnstimeout)=10)
same => n,Set(CURLOPT(conntimeout)=10)
same => n,Set(CURLOPT(httptimeout)=10)
same => n,Set(CURLOPT(useragent)=OMniLeads)
same => n,Set(CURL_RESULT=${CURL(${DB(OML/CUSTOMERID/${ARG1}/EXTERNALURL)},idContact=${OMLCODCLI})})
same => n,Verbose(2,${JSONELEMENT(CURL_RESULT,status)})
same => n,Verbose(2,${JSONELEMENT(CURL_RESULT,destination)})
same => n,ExecIf($["${JSONELEMENT(CURL_RESULT,status)}" == "ok"]?Set(CRMCHOICE=${JSONELEMENT(CURL_RESULT,destination)}):Goto(goOut))
same => n,GotoIf($[${ISNULL(${CRMCHOICE})}]?goOut)
same => n,Gosub(sub-oml-dst-switch,s,1(${CRMCHOICE}))
same => n,Return()

same => n(goOut),Gosub(sub-oml-dst-switch,s,1(${DB(OML/CUSTOMERID/${ARG1}/FALSEDST)}))
same => n,Return()
