---
- include: installations.yml

- include: mariadb.yml

- include: roles/prerequisitos/tasks/reboot.yml
  when:  ansible_os_family == "RedHat" and ansible_connection != "local"

- name: Wait for the server to finish rebooting
  become: no
  wait_for: host="{{ omni_ip }}" delay=15 state=started port={{ ansible_ssh_port }} timeout=600
  delegate_to: localhost
  when: iface == "none"

- name: Wait for the server to finish rebooting (cluster)
  become: no
  local_action: wait_for host="{{ dialer_ip }}" delay=15 state=started port={{ ansible_ssh_port }} timeout=600
  when: cluster !=0

# (pero garantizando que se ejecuten al final de toda la instalaci√≥n)
- name: OML Environment Initialization
  command: "{{ install_prefix }}bin/manage.sh inicializar_entorno"
  become: true
  become_method: su
  become_user: "{{ usuario }}"
  tags: integration-tests

- name: Run integration tests that not depends on real browser
  shell: "{{ install_prefix }}virtualenv/bin/python {{ install_prefix}}ominicontacto/ominicontacto_app/tests/tests.py"
  register: out
  environment:
    TESTS_INTEGRACION: True
    ADMIN_USERNAME: "{{ admin_user }}"
    ADMIN_PASSWORD: "{{ admin_pass }}"
  become: true
  become_method: su
  become_user: "{{ usuario }}"
  become_flags: '-s /bin/bash'
  tags: integration-tests
