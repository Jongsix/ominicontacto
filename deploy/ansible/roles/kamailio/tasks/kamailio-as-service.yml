---

- name: Creation of kamamailio run directories
  file: "path={{ item }} state=directory mode=0755"
  with_items:
      - "{{ kamailio_location }}/run/"
      - "{{ kamailio_location }}/run/kamailio/"
  become: true
  become_method: sudo

- name: Create kamailio.log file and directory
  file: path=/var/log/kamailio/ state=directory mode=0755
  become: true
  become_method: sudo

- file: path=/var/log/kamailio/kamailio.log state=touch mode=0755
  become: true
  become_method: sudo

- name: Copy of oml/kamailio-files to the desired destinations
  shell: "{{ item }} chdir={{ install_prefix }}ominicontacto/ominicontacto_voip"
  with_items:
      - cp kamailio-files/kamctlrc {{ kamailio_location }}/etc/kamailio/

- name: Creation of kamailio file in /etc/default
  template: src=templates/kamailio.j2 dest=/etc/default/kamailio owner=root group=root mode=755

- name: Creation of kamailio.service file in systemd
  template: src=templates/kamailio.service.j2 dest=/etc/systemd/system/kamailio.service owner=root group=root mode=650

- name: Run kamailio as a service
  shell: "{{ item }}"
  with_items:
      - systemctl restart rsyslog
      - systemctl enable kamailio
      - systemctl daemon-reload
      - "chown {{ usuario }}:{{ usuario }} -R {{ kamailio_location }}"
  become: true
  become_method: sudo

- name: Execution of kamdbctl script
  shell: "echo 'y' | {{ kamailio_location }}/sbin/kamdbctl create"
  when: kamailio_installed|failed
  become: true
  become_method: sudo
  register: command_result
  failed_when:
    - "'already exists' not in command_result.stderr"
    - "'ya existe' not in command_result.stderr"
    - "command_result.rc != 0"

- name: Creation of kamailio-local.cfg file
  template: src=templates/kamailio-local.cfg dest={{ kamailio_location }}/etc/kamailio/ owner={{ usuario }} group={{ usuario }}
  tags: postinstall
  become: true
  become_method: sudo

- name: Erase of default kamailio.cfg file
  shell: rm -rf {{ kamailio_location }}/etc/kamailio/kamailio.cfg
  tags: postinstall

- name: Link kamailio.cfg repo file to {{ kamailio_location }}
  file: state=link src={{ install_prefix }}ominicontacto/ominicontacto_voip/kamailio-files/kamailio.cfg dest={{ kamailio_location }}/etc/kamailio/kamailio.cfg force=true owner={{ usuario }} group={{ usuario }} mode=644
  tags: postinstall
  become: true
  become_method: sudo

- name: Link kamcmd binarie to /usr/sbin
  file: state=link src={{ kamailio_location }}/sbin/kamcmd dest=/usr/sbin/kamcmd mode=755 force=true

- name: Link kamctl binarie to /usr/sbin
  file: state=link src={{ kamailio_location }}/sbin/kamctl dest=/usr/sbin/kamctl mode=755 force=true

- name: Template of omnileads-iptables
  template: src=templates/omnileads-iptables dest={{ install_prefix }}bin/omnileads-iptables mode=755
