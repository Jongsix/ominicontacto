{% load static %}
{% load compress %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'bootstrap-4.0.0/css/bootstrap.min.css' %}" >
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/daterangepicker.css' %}">
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/bootstrap-datetimepicker.min.css' %}"></link>
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/daterangepicker.css' %}"></link>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/main.css' %}" ></link>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Asap:400,500" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'ominicontacto/CSS/oml-agent.css' %}">
    <!-- Scripts -->
    {% compress js %}
    <script src="{% static 'jquery-2.2.4.min.js' %}"></script>
    <script src="{% static 'bootstrap-4.0.0/js/bootstrap.bundle.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'ominicontacto/JS/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'ominicontacto/JS/bootstrap-datetimepicker.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'ominicontacto/JS/daterangepicker.js' %}"></script>
    {% endcompress %}

    <!-- TODO: REMOVER - FIX HASTA CAMBIAR BS3 por BS4 -->
    <style type="text/css">
      .fade {
        opacity: 1;
      }
    </style>

</head>


<script type="text/javascript">/* TODO: este código debería estar en un archivo separado  */
   $(function() {
     var start = moment();
     var end = moment();
     function cb(start, end) {
       $('#id_fecha').html(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));
     }

     $('#id_fecha').on('apply.daterangepicker', function(ev, picker) {
       $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
     });

     $('#id_fecha').on('cancel.daterangepicker', function(ev, picker) {
       $(this).val('.calificacionContacto');
     });

     // Init daterange plugin
     $('#id_fecha').daterangepicker(
       {
         locale: {
           format: 'DD/MM/YYYY'
         },

         startDate: start,
         endDate: end,
         ranges: {
           'Hoy': [moment(), moment()],
           'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Ultimos 7 Días': [moment().subtract(6, 'days'), moment()],
           'Ultimos 30 Días': [moment().subtract(29, 'days'), moment()],
           'Este Mes': [moment().startOf('month'), moment().endOf('month')],
           'Ultimo Mes': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
         },

       }, cb);

     cb(start, end);

     $(".btn-submit").click(function (){
       var action = $(this).attr("name");
       var pk_contacto = $(this).attr("pk_contacto");
       var pk_agente = $(this).attr("agente");
       var tipo_campana = $(this).attr("tipo_campana");
       var campana_nombre = $(this).attr("campana_nombre");
       var pk_campana = $(this).attr("pk_campana");
       submit_form(pk_contacto, pk_agente, action, tipo_campana, campana_nombre, pk_campana);
     })

     function submit_form(pk_contacto, pk_agente, action, tipo_campana, campana_nombre, pk_campana){
       $("#pk_contacto").val(pk_contacto);
       $("#pk_agente").val(pk_agente);
       $("#tipo_campana").val(tipo_campana);
       $("#pk_campana").val(pk_campana);
       $("#campana_nombre").val(campana_nombre);
       $("#form_llamar").attr("action", action);
       $("#form_llamar").submit();
     }
});
    </script>
<body>
{% include 'messages.html' %}
<h1>Agente {{ agente.user.get_full_name }}</h1>
<div class="wrapper-dropdown">
    <div class="dropdown">
        <button class="btn btn-light dropdown-toggle" type="button" id="dropdownExportActions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Exportar
        </button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownExportActions">
            <a class="dropdown-item" href="{% url 'exporta_reporte_calificaciones' agente.pk %}">Exportar Calificacion(CSV)</a>
            <a class="dropdown-item" href="{% url 'exporta_reporte_formularios' agente.pk %}">Exportar Gestion(CSV)</a>
        </div>
    </div>
</div>
<form role="form" method="post" enctype="multipart/form-data" class="form-inline">
    {% csrf_token %}
    <div class="date active" id="">
       {{form.fecha}}
        <button type="submit" id="id_buscar_btn" class="btn btn-primary">
            Filtrar
        </button>
    </div>
</form>
<hr>
 <form id="form_llamar" role="form" method="post" >
        {% csrf_token %}
     <input type="hidden" id="pk_agente" name="pk_agente">
     <input type="hidden" id="pk_contacto" name="pk_contacto">
     <input type="hidden" id="pk_campana" name="pk_campana">
     <input type="hidden" id="campana_nombre" name="campana_nombre">
     <input type="hidden" id="click2call_type" name="click2call_type" value="calificaciones">
     <input type="hidden" id="tipo_campana" name="tipo_campana">
                <table class="table">
                    <thead>
                      <tr class="fts-table-bg">
                        <th>Teléfono</th>
                        <th>Datos</th>
                        <th>Gestionado</th>
                        <th>Calificación</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                        {% for calificacion_cliente in listado_calificaciones %}
                            <tr>
                                <td>
                                    <button type="button" class="btn btn-outline-primary" pk_contacto="{{ calificacion_cliente.contacto.pk }}"
                                       tipo_campana="{{ calificacion_cliente.opcion_calificacion.campana.type }}"
                                       campana_nombre="{{ calificacion_cliente.opcion_calificacion.campana.nombre }}"
                                       pk_campana="{{ calificacion_cliente.opcion_calificacion.campana.pk }}"
                                       agente="{{agente.pk}}" name="{% url 'agente_llamar_contacto' %}">{{ calificacion_cliente.contacto.telefono }}</button>
                                </td>
                                <td>
                                    {{ calificacion_cliente.contacto.datos}}
                                </td>
                                <td>
                                    {% if calificacion_cliente.es_venta %}
                                        <span class="icon icon-check" aria-hidden="true"></span>
                                    {% else %}
                                        <span class="icon icon-cancel" aria-hidden="true"></span>
                                    {% endif %}
                                </td>
                                <td>
                                  {{ calificacion_cliente.opcion_calificacion.nombre }}
                                </td>
                                <td>
                                    {% if calificacion_cliente.observaciones %}
                                        {{ calificacion_cliente.observaciones }}
                                    {% endif %}
                                </td>
                                <td>
                                  <div class="dropdown">
                                      <button class="btn btn-light dropdown-toggle" type="button" id="dropdownActions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                      Opciones
                                      </button>
                                      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownActions">
                                          <a class="dropdown-item" href="{% url 'calificacion_cliente_actualiza_desde_reporte' calificacion_cliente.opcion_calificacion.campana_id calificacion_cliente.contacto_id agente.pk calificacion_cliente.wombat_id %}">
                                            <span class="icon icon-pencil"></span>Calificación
                                          </a>
                                          {% if calificacion_cliente.get_venta %}
                                              <a class="dropdown-item" href="{% url 'formulario_venta_update' calificacion_cliente.get_venta.pk %}">
                                                <span class="icon icon-pencil"></span>Gestión
                                              </a>
                                          {% endif %}
                                      </div>
                                  </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
     </form>
</body>
</html>
