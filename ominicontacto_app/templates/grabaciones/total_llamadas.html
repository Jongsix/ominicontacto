{% extends "base.html" %}
{% load static %}
{% block head_js %}
<script type="text/javascript">
   $(function() {
                var start = moment();
                var end = moment();
                function cb(start, end) {
                    $('#id_fecha').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                }

 $('#id_fecha').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
  });

  $('#id_fecha').on('cancel.daterangepicker', function(ev, picker) {
      $(this).val('');
});

            // Init daterange plugin
            $('#id_fecha').daterangepicker(
                {

                locale: {
                    format: 'DD/MM/YYYY'
                 },

                startDate: start,
                endDate: end,
                ranges: {
                    'Hoy': [moment(), moment()],
                    'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Ultimos 7 Días': [moment().subtract(6, 'days'), moment()],
                    'Ultimos 30 Días': [moment().subtract(29, 'days'), moment()],
                    'Este Mes': [moment().startOf('month'), moment().endOf('month')],
                    'Ultimo Mes': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },

        }, cb);

        cb(start, end);

});
    </script>
{% endblock %}
{% block content %}
 <script type="text/javascript" src="{% static 'ominicontacto/JS/pygal-tooltips.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'ominicontacto/JS/pygal-tooltips.js' %}"></script>


<h1>Llamadas</h1>

{% with graficos_estadisticas=graficos_estadisticas %}

<div id="wrapper-search">
  <button id="btnCollapse" class="btn btn-block" type="button" data-toggle="collapse" data-target="#wrapperSearchForm" aria-expanded="true" aria-controls="wrapperSearchForm"><span class="icon icon-search"></span> Buscar </button>   

  <div id="wrapperSearchForm" class="show">
    <form role="form" method="post" enctype="multipart/form-data" >
      {% csrf_token %}
      <div class="form-row">
        <div class="col-md-6">
          <label>Fecha: </label>
            <div class="input-group date pull-right active" id="">
              {{form.fecha}}
            </div>
        </div>
        <div class="col-md-6">
          <label>Incluir campañas finalizadas</label>
           {{form.finalizadas}}
        </div>       
      </div>

      <button type="submit" id="id_buscar_btn" class="btn btn-primary">
        Filtrar por esa fecha
      </button>    
    </form>
  </div> 

</div>

    <div>
      <h2>Periodo evaluado {{graficos_estadisticas.estadisticas.fecha_desde|date:"d/m/Y"}} - {{graficos_estadisticas.estadisticas.fecha_hasta|date:"d/m/Y"}}</h2>
    </div>
    {% if user.get_is_administrador %}
    <div>
      {% with total_llamadas=graficos_estadisticas.estadisticas.total_llamadas_dict %}
      <table class="table table-bordered">
        <tr>
          <td><strong>Total llamadas procesadas por OmniLeads</strong></td>
          <td>{{total_llamadas.total_llamadas_ingresadas}}</td>
        </tr>
      </table>
      <table class="table table-bordered">
        <tr>
          <td><strong>Total de llamadas Salientes Discador</strong></td>
          <td>{{total_llamadas.llamadas_ingresadas_dialer}}</td>
        </tr>
        <tr>
          <td>Cantidad de llamadas gestionadas</td>
          <td>{{total_llamadas.llamadas_gestionadas_dialer}}</td>
        </tr>
        <tr>
          <td>Cantidad de llamadas perdidas</td>
          <td>{{total_llamadas.llamadas_perdidas_dialer}}</td>
        </tr>
      </table>
      <table class="table table-bordered">
        <tr>
          <td><strong>Total llamadas Entrantes</strong></td>
          <td>{{total_llamadas.llamadas_ingresadas_entrantes}}</td>
        <tr>
        <tr>
          <td>Cantidad de llamadas atendidas</td>
          <td>{{total_llamadas.llamadas_atendidas_entrantes}}</td>
        <tr>
        <tr>
          <td>Cantidad de llamadas expiradas</td>
          <td>{{total_llamadas.llamadas_expiradas_entrantes}}</td>
        <tr>
        <tr>
          <td>Cantidad de llamadas abandonadas</td>
          <td>{{total_llamadas.llamadas_abandonadas_entrantes}}</td>
        <tr>
      </table>
      <table class="table table-bordered">
        <tr>
          <td><strong>Total llamadas Salientes Manuales</strong></td>
          <td>{{total_llamadas.llamadas_ingresadas_manuales}}</td>
        </tr>
        <tr>
          <td>Cantidad de llamadas atendidas</td>
          <td>{{total_llamadas.llamadas_atendidas_manuales}}</td>
        </tr>
        <tr>
          <td>Cantidad de llamadas abandonadas</td>
          <td>{{total_llamadas.llamadas_abandonadas_manuales}}</td>
        </tr>
      </table>
      <table class="table table-bordered">
        <tr>
          <td><strong>Total llamadas Salientes Preview</strong></td>
          <td>{{total_llamadas.llamadas_ingresadas_preview}}</td>
        </tr>
        <tr>
          <td>Cantidad de llamadas atendidas</td>
          <td>{{total_llamadas.llamadas_atendidas_preview}}</td>
        </tr>
        <tr>
          <td>Cantidad de llamadas abandonadas</td>
          <td>{{total_llamadas.llamadas_abandonadas_preview}}</td>
        </tr>
      </table>
      {% endwith %}
      <form action="{% url 'exportar_llamadas' tipo_reporte='total_llamadas' %}" method="POST">
          {% csrf_token %}
          <input class="hidden" name="total_llamadas" type="text" value="{{ graficos_estadisticas.estadisticas.total_llamadas_json }}"/>
          <button class="btn btn-primary">Exportar totales llamadas(CSV)</button>
          <br>
      </form>
    </div>
    <div>
        <form action="{% url 'exportar_zip_reportes' %}" method="POST">
            {% csrf_token %}
            <input class="hidden" name="total_llamadas" type="text" value="{{ graficos_estadisticas.estadisticas.total_llamadas_json }}"/>
            <input class="hidden" name="llamadas_campanas" type="text" value="{{ graficos_estadisticas.dict_campana_counter_json }}"/>
            <input class="hidden" name="llamadas_campanas_dialer" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_dialer_json }}"/>
            <input class="hidden" name="llamadas_campanas_entrantes" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_entrantes_json }}"/>
            <input class="hidden" name="llamadas_campanas_manuales" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_manuales_json }}"/>
            <button class="btn btn-primary">Exportar a CSV todos los reportes</button>
            <br>
        </form>
    </div>
    {% endif %}

    <table class="table table-bordered">
      <thead>
        <tr >
          <td colspan="2">
            <h3>Totales llamadas.</h3>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><h4>Totales llamadas por tipo de campaña y forma de finalización</h4></td>
          <td><h4>Porcentajes llamadas por tipo de campaña</h4></td>
        </tr>
        <tr>
          <td width="50%" align="center">
            <div class="graficos-avances">
              <figure>
                {{ graficos_estadisticas.barras_llamadas_por_tipo.render|safe }}
              </figure>
            </div>
          </td>
          <td width="50%" align="center">
            <div class="graficos-avances">
              <figure>
                {{ graficos_estadisticas.torta_porcentajes_por_tipo.render|safe }}
              </figure>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <table class="table table-bordered">
        <thead>
            <tr class="fts-table-bg">
                <td colspan="2">
                    <h3>Cantidad de llamadas por campaña</h3>
                </td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td width="50%">
                    <div style="overflow: auto; height: 500px">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Campaña</th>
                                    <th>Total </th>
                                    <th>Manuales </th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for campana_nombre, total_campana, total_manuales, tipo_campana in graficos_estadisticas.dict_campana_counter %}
                                    <tr>
                                        <td><h5>{{ campana_nombre }} </h5></td>
                                        <td width="10%" align="right"><h5><span class="label label-primary">{{ total_campana }}</span></h5></td>
                                        <td width="10%" align="right"><h5><span class="label label-primary">{{ total_manuales }}</span></h5></td>
                                        <td><h5>{{ tipo_campana }}</h5></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
                <td width="50%" align="center">
                    <div class="graficos-avances">
                        <figure>
                            {{ graficos_estadisticas.barra_llamada_por_campana.render|safe }}
                        </figure>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <form action="{% url 'exportar_llamadas' tipo_reporte='llamadas_campanas' %}" method="POST">
        {% csrf_token %}
        <input class="hidden" name="llamadas_campanas" type="text" value="{{ graficos_estadisticas.dict_campana_counter_json }}"/>
        <button class="btn btn-primary">Exportar llamadas por campaña (CSV)</button>
        <br>
    </form>
    <br/>

    <div>
      <div id="seccion-llamadas-dialer" style="border:1px solid #cecece;">
        <h3>Distribucion de tipos de llamadas en campañas salientes discador </h3>
      <div style="overflow: auto; height: 200px">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Campaña</th>
            <th>Recibidas</th>
            <th>Atendidas</th>
            <th>Expiradas</th>
            <th>Abandonadas</th>
          </tr>
        </thead>
        {% for campana in graficos_estadisticas.estadisticas.queues_llamadas_dialer %}
        <tr>
          <td>{{campana.0}}</td>
          <td>{{campana.1}}</td>
          <td>{{campana.2}}</td>
          <td>{{campana.3}}</td>
          <td>{{campana.4}}</td>
        </tr>
        {% endfor %}
      </table>
      </div>
      <div class="graficos-avances">
        <figure>
          {{ graficos_estadisticas.barra_campana_llamadas_dialer.render|safe }}
        </figure>
        <form action="{% url 'exportar_llamadas' tipo_reporte='llamadas_campanas_dialer' %}" method="POST">
            {% csrf_token %}
            <input class="hidden" name="llamadas_campanas_dialer" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_dialer_json }}"/>
            <button class="btn btn-primary">Exportar llamadas campañas dialer</button>
            <br>
        </form>
      </div>
      </div>
      <br/>

      <div id="seccion-llamadas-entrantes" style="border:1px solid #cecece;">
        <h3>Distribucion de tipos de llamadas en campañas entrantes </h3>
      <div style="overflow: auto; height: 200px">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Campaña</th>
            <th>Recibidas</th>
            <th>Atendidas</th>
            <th>Expiradas</th>
            <th>Abandonadas</th>
          </tr>
        </thead>
        {% for campana in graficos_estadisticas.estadisticas.queues_llamadas_entrantes %}
        <tr>
          <td>{{campana.0}}</td>
          <td>{{campana.1}}</td>
          <td>{{campana.2}}</td>
          <td>{{campana.3}}</td>
          <td>{{campana.4}}</td>
        </tr>
        {% endfor %}
      </table>
      </div>
      <div class="graficos-avances">
        <figure>
          {{ graficos_estadisticas.barra_campana_llamadas_entrantes.render|safe }}
        </figure>
        <form action="{% url 'exportar_llamadas' tipo_reporte='llamadas_campanas_entrantes' %}" method="POST">
            {% csrf_token %}
            <input class="hidden" name="llamadas_campanas_entrantes" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_entrantes_json }}"/>
            <button class="btn btn-primary">Exportar llamadas campañas entrantes</button>
            <br>
        </form>
      </div>
      </div>
      <br/>

      <div id="seccion-llamadas-manuales" style="border:1px solid #cecece;">
        <h3>Distribucion de tipos de llamadas en campañas manuales </h3>
      <div style="overflow: auto; height: 200px">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Campaña</th>
            <th>Recibidas</th>
            <th>Atendidas</th>
            <th>Expiradas</th>
            <th>Abandonadas</th>
          </tr>
        </thead>
        {% for campana in graficos_estadisticas.estadisticas.queues_llamadas_manuales %}
        <tr>
          <td>{{campana.0}}</td>
          <td>{{campana.1}}</td>
          <td>{{campana.2}}</td>
          <td>{{campana.3}}</td>
          <td>{{campana.4}}</td>
        </tr>
        {% endfor %}
      </table>
      </div>
      <div class="graficos-avances">
        <figure>
          {{ graficos_estadisticas.barra_campana_llamadas_manuales.render|safe }}
        </figure>
        <form action="{% url 'exportar_llamadas' tipo_reporte='llamadas_campanas_manuales' %}" method="POST">
            {% csrf_token %}
            <input class="hidden" name="llamadas_campanas_manuales" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_manuales_json }}"/>
            <button class="btn btn-primary">Exportar llamadas campañas manuales</button>
            <br>
        </form>
      </div>
      </div>
      <br/>

      <div id="seccion-llamadas-preview" style="border:1px solid #cecece;">
        <h3>Distribucion de tipos de llamadas en campañas Preview </h3>
      <div style="overflow: auto; height: 200px">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Campaña</th>
            <th>Recibidas</th>
            <th>Atendidas</th>
            <th>Expiradas</th>
            <th>Abandonadas</th>
          </tr>
        </thead>
        {% for campana in graficos_estadisticas.estadisticas.queues_llamadas_preview %}
        <tr>
          <td>{{campana.0}}</td>
          <td>{{campana.1}}</td>
          <td>{{campana.2}}</td>
          <td>{{campana.3}}</td>
          <td>{{campana.4}}</td>
        </tr>
        {% endfor %}
      </table>
      </div>
      <div class="graficos-avances">
        <figure>
          {{ graficos_estadisticas.barra_campana_llamadas_preview.render|safe }}
        </figure>
        <form action="{% url 'exportar_llamadas' tipo_reporte='llamadas_campanas_preview' %}" method="POST">
            {% csrf_token %}
            <input class="hidden" name="llamadas_campanas_preview" type="text" value="{{ graficos_estadisticas.estadisticas.queues_llamadas_preview_json }}"/>
            <button class="btn btn-primary">Exportar llamadas campañas Preview</button>
            <br>
        </form>
      </div>
      </div>

    </div>
{% endwith %}
{% endblock %}
